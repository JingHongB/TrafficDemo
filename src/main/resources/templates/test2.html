<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
  <title>位置经纬度 + 驾车规划路线</title>
  <style>
    html,
    body,
    #container {
      width: 100%;
      height: 100%;
    }

    #panel {
      position: fixed;
      background-color: white;
      max-height: 90%;
      overflow-y: auto;
      top: 10px;
      right: 10px;
      width: 280px;
    }

    #panel .amap-call {
      background-color: #009cf9;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }

    #panel .amap-lib-driving {
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 4px;
      overflow: hidden;
    }
  </style>
  <!-- 加载高德地图的安全配置 -->
  <script>
    window._AMapSecurityConfig = {
      securityJsCode: 'ad72dc1ba317900ed9b2b9d3c4b1c8d7',
    }
  </script>
  <!-- 加载高德地图的样式 -->
  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
</head>

<body>
  <!-- 地图容器 -->
  <div id="container"></div>
  <!-- 信息面板 -->
  <div id="panel"></div>
  <!-- 加载高德地图的JavaScript API -->
  <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=6251ae8c4c45a9002c208178445e0572&plugin=AMap.Driving"></script>

  <script type="text/javascript" th:inline="javascript">
    // 创建地图实例
    var map = new AMap.Map("container", {
      resizeEnable: true,
      center: [104.065861, 30.657401], // 地图中心点的经纬度
      zoom: 13 // 地图缩放级别
    });


    // 定义多个起始点和终点
    var routes = [
      {
        startPoint: new AMap.LngLat(104.065943, 30.65811), // 起始点的经纬度
        endPoint: new AMap.LngLat(104.03892, 30.664179)// 终点的经纬度
      },
      {
        startPoint: new AMap.LngLat(104.090, 30.670), // 起始点的经纬度
        endPoint: new AMap.LngLat(104.040, 30.660) // 终点的经纬度
      }
    ];

    // 为每条线路创建一个驾驶规划实例
    routes.forEach(route => {
      // 创建驾驶规划实例
      route.driving = new AMap.Driving({
        map: map, // 指定地图对象
        policy: AMap.DrivingPolicy.REAL_TRAFFIC, // 设置驾车策略，此处为考虑实时交通情况
        hideMarkers: true // 隐藏起点和终点标记
      });

        
      // 创建起点标记
      route.marker = new AMap.Marker({
        map: map, // 指定地图对象
        position: route.startPoint,
        icon: new AMap.Icon({
            size: new AMap.Size(40, 50),  // 图标尺寸
            image:'van.png',  // Icon的图像
            imageOffset: new AMap.Pixel(0, -5),  // 图像相对于可视区域的偏移量
            imageSize: new AMap.Size(30, 40)   // 根据所设置的大小拉伸或压缩图片
        }) // 设置标记位置为起始点
      });

      // 更新路径
      function updateRoute(route) {
        // 发起驾驶路径规划请求
        route.driving.search(route.startPoint, route.endPoint, function(status, result) {
          // 判断请求状态是否成功并且是否有规划路线
          if (status === 'complete' && result.routes && result.routes.length) {
            // 提取路径中的所有经纬度点
            var pathPoints = result.routes[0].steps.reduce((acc, step) => acc.concat(step.path), []);
            // 移动标记沿着路径
            moveAlongPath(route, pathPoints);
          } else {
            // 输出错误信息到控制台
            console.log("路径规划失败：" + result.message);
          }
        });
      }

      // 沿着路径移动标记
      function moveAlongPath(route, pathPoints) {
        let index = 0; // 初始化当前点的索引
        const interval = 500; // 设置每次移动的时间间隔
        const distanceThreshold = 50; // 设置距离阈值，当标记距离终点小于该阈值时重新规划路径
        const timer = setInterval(() => {
          if (index >= pathPoints.length) { // 到达路径终点时清除定时器
            clearInterval(timer);
            return;
          }
          route.marker.setPosition(pathPoints[index]); // 设置标记位置为当前路径点
          index++; // 更新当前点的索引
          if (index % 100 === 0) { // 每100个点检查一次是否需要重新规划路径
            // 当标记距离终点小于阈值时重新规划路径
            if (route.marker.getPosition().distance(route.endPoint) < distanceThreshold) {
              updateRoute(route);
            }
          }
        }, interval);
      }

      // 初始化并启动路径移动
      updateRoute(route);
    });
  </script>
</body>

</html>
